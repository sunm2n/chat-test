<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chat-blue': '#3B82F6',
                        'chat-green': '#10B981',
                        'chat-gray': '#F3F4F6',
                        'chat-dark': '#1F2937'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-chat-dark mb-2">💬 실시간 채팅</h1>
            <p class="text-gray-600">사용자 이름과 채팅방을 입력하여 대화를 시작하세요</p>
        </div>
        
        <!-- Connection Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">채팅방 연결</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">사용자 이름</label>
                    <input type="text" id="usernameInput" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-chat-blue focus:border-transparent transition-all duration-200 outline-none" 
                           placeholder="이름을 입력하세요" value="홍길동" />
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">채팅방 ID</label>
                    <input type="text" id="roomIdInput" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-chat-blue focus:border-transparent transition-all duration-200 outline-none" 
                           placeholder="채팅방 ID를 입력하세요" value="room-001" />
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="connectBtn" 
                        class="flex-1 bg-chat-blue hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:ring-4 focus:ring-blue-200 shadow-lg">
                    🚀 채팅방 입장
                </button>
                <button id="disconnectBtn" disabled
                        class="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:ring-4 focus:ring-red-200 shadow-lg">
                    🚪 채팅방 나가기
                </button>
            </div>
        </div>
        
        <!-- Status -->
        <div id="status" class="bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg mb-6 font-medium">
            📡 연결되지 않음
        </div>
        
        <!-- Chat Container -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Chat Messages -->
            <div id="chatMessages" class="h-80 sm:h-96 overflow-y-auto p-4 bg-gradient-to-b from-gray-50 to-white border-b space-y-3">
                <!-- 귀여운 Empty State -->
                <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <div class="text-6xl mb-4 animate-bounce">💬</div>
                    <p class="text-lg font-medium mb-2">아직 메시지가 없어요!</p>
                    <p class="text-sm text-center">채팅방에 입장해서 대화를 시작해보세요 ✨</p>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="p-4 bg-white border-t border-gray-100">
                <div class="flex gap-3">
                    <input type="text" id="messageInput" disabled
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-chat-green focus:border-transparent transition-all duration-200 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed shadow-sm" 
                           placeholder="메시지를 입력하세요..." />
                    <button id="sendBtn" disabled
                            class="bg-chat-green hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 sm:px-6 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:ring-4 focus:ring-green-200 shadow-lg">
                        <span class="hidden sm:inline">📤 전송</span>
                        <span class="sm:hidden">📤</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <script>
        let stompClient = null;
        let connected = false;

        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');
        const status = document.getElementById('status');
        const usernameInput = document.getElementById('usernameInput');
        const roomIdInput = document.getElementById('roomIdInput');

        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });

        function connect() {
            const username = usernameInput.value;
            const roomId = roomIdInput.value;

            if (!username || !roomId) {
                alert('사용자 이름과 채팅방 ID를 입력해주세요.');
                return;
            }

            const socket = new SockJS(`/ws-chat?username=${encodeURIComponent(username)}&roomId=${roomId}`);
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: (str) => console.log(str),
                onConnect: () => {
                    connected = true;
                    updateUI();
                    
                    stompClient.subscribe(`/sub/room/${roomId}`, (message) => {
                        const chatMessage = JSON.parse(message.body);
                        displayMessage(chatMessage);
                    });

                    status.textContent = `🟢 연결됨 - 채팅방: ${roomId}, 사용자: ${username}`;
                    status.className = "bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded-lg mb-6 font-medium";
                    
                    // 자동으로 채팅방 입장
                    joinRoom();
                },
                onStompError: (frame) => {
                    console.error('STOMP error: ', frame);
                    status.textContent = '❌ 연결 오류';
                    status.className = "bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg mb-6 font-medium";
                },
                onDisconnect: () => {
                    connected = false;
                    updateUI();
                    status.textContent = '📡 연결 해제됨';
                    status.className = "bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg mb-6 font-medium";
                }
            });

            stompClient.activate();
        }

        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
            }
        }

        function sendMessage() {
            const message = messageInput.value;
            const roomId = roomIdInput.value;
            const username = usernameInput.value;

            if (message && stompClient && connected) {
                const chatMessage = {
                    roomId: roomId,
                    message: message,
                    senderId: username,
                    messageType: 'CHAT'
                };

                stompClient.publish({
                    destination: '/pub/room/chat/send',
                    body: JSON.stringify(chatMessage)
                });

                messageInput.value = '';
            }
        }

        function joinRoom() {
            const roomId = roomIdInput.value;
            const username = usernameInput.value;

            if (stompClient && connected) {
                const joinMessage = {
                    roomId: roomId,
                    senderId: username,
                    messageType: 'JOIN'
                };

                stompClient.publish({
                    destination: '/pub/room/chat/join',
                    body: JSON.stringify(joinMessage)
                });
            }
        }

        function leaveRoom() {
            const roomId = roomIdInput.value;
            const username = usernameInput.value;

            if (stompClient && connected) {
                const leaveMessage = {
                    roomId: roomId,
                    senderId: username,
                    messageType: 'LEAVE'
                };

                stompClient.publish({
                    destination: '/pub/room/chat/leave',
                    body: JSON.stringify(leaveMessage)
                });
            }
        }

        function displayMessage(message) {
            const messageElement = document.createElement('div');
            const time = new Date(message.timestamp).toLocaleTimeString();
            
            // 귀여운 사용자 아바타 색상 배열
            const avatarColors = [
                'bg-pink-400', 'bg-purple-400', 'bg-blue-400', 'bg-green-400', 
                'bg-yellow-400', 'bg-red-400', 'bg-indigo-400', 'bg-teal-400'
            ];
            const avatarColor = avatarColors[message.senderName.charCodeAt(0) % avatarColors.length];
            
            
            if (message.messageType === 'SYSTEM' || message.messageType === 'JOIN' || message.messageType === 'LEAVE') {
                // 귀여운 시스템 메시지
                messageElement.className = "flex justify-center mb-4 animate-bounce-in";
                const emoji = message.messageType === 'JOIN' ? '🎉' : message.messageType === 'LEAVE' ? '👋' : '🔔';
                messageElement.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-yellow-300 text-yellow-800 px-6 py-3 rounded-full text-sm font-medium shadow-lg transform hover:scale-105 transition-all duration-300">
                        <span class="text-lg">${emoji}</span> ${message.message}
                        <span class="text-xs text-yellow-600 ml-2 opacity-70">• ${time}</span>
                    </div>
                `;
            } else {
                // 귀여운 채팅 메시지
                const isOwnMessage = message.senderName === usernameInput.value;
                const alignment = isOwnMessage ? 'justify-end' : 'justify-start';
                const flexDirection = isOwnMessage ? 'flex-row-reverse' : 'flex-row';
                
                messageElement.className = `flex ${alignment} mb-4 animate-slide-in`;
                
                if (isOwnMessage) {
                    // 내 메시지 - 파스텔 블루 버블
                    messageElement.innerHTML = `
                        <div class="flex ${flexDirection} items-end space-x-2 max-w-xs lg:max-w-md group">
                            <div class="w-8 h-8 ${avatarColor} rounded-full flex items-center justify-center text-white text-sm font-bold shadow-lg transform group-hover:scale-110 transition-transform duration-200">
                                ${message.senderName.charAt(0)}
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1 text-right">
                                    ${message.senderName} • ${time}
                                </div>
                                <div class="bg-gradient-to-r from-blue-400 to-purple-500 text-white rounded-3xl rounded-br-md px-5 py-3 shadow-lg transform hover:shadow-xl transition-all duration-200 relative">
                                    <p class="text-sm leading-relaxed">${message.message}</p>
                                    <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full border-2 border-white shadow-sm"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // 다른 사람 메시지 - 파스텔 화이트 버블
                    messageElement.innerHTML = `
                        <div class="flex ${flexDirection} items-end space-x-2 max-w-xs lg:max-w-md group">
                            <div class="w-8 h-8 ${avatarColor} rounded-full flex items-center justify-center text-white text-sm font-bold shadow-lg transform group-hover:scale-110 transition-transform duration-200">
                                ${message.senderName.charAt(0)}
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">
                                    ${message.senderName} • ${time}
                                </div>
                                <div class="bg-white border-2 border-gray-200 rounded-3xl rounded-bl-md px-5 py-3 shadow-lg transform hover:shadow-xl transition-all duration-200 relative">
                                    <p class="text-sm leading-relaxed text-gray-800">${message.message}</p>
                                    <div class="absolute -bottom-1 -left-1 w-4 h-4 bg-white rounded-full border-2 border-gray-200 shadow-sm"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 애니메이션을 위한 초기 상태 설정
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';
            
            // Empty state 숨기기
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            chatMessages.appendChild(messageElement);
            
            // 애니메이션 실행
            setTimeout(() => {
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
                messageElement.style.transition = 'all 0.3s ease-out';
            }, 10);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateUI() {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            sendBtn.disabled = !connected;
            messageInput.disabled = !connected;
        }
    </script>
</body>
</html>